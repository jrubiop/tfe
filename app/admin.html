<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- === <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> === -->
    <!-- === <script language="javascript" type="text/javascript" src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script> === -->
    <script language="javascript" type="text/javascript" src="js/jquery.min.js"></script>

    <script language="javascript" type="text/javascript" src="js/datos.js"></script>
    
    <!-- <script language="javascript" type="text/javascript" src="js/web3.min.js"></script> -->
    <script language="javascript" type="text/javascript" src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <link href="./css/estilos.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>TFE: App Editores</title>
  </head>
  <body class="main">
    <h2>Editor (administrador y colaborador)</h2>
    <span>Para gestionar colaboradores y piezas</span>

    <div class="container">
      <!-- Botones de acciones especiales -->
      <div class="row">
        <div class="col-8">
          <div id="botonesAcciones" class="container" style="display: none;">
            <button id="conectarWallet" name="conectarWallet" type="button" class="btn btn-secondary">Conectar Metamask</button>
            <label for="inputCuenta" class="form-label">Cuenta</label>
            <input type="text" id="inputCuenta">
            <button id="saldoWallet"    name="saldoWallet" type="button" class="btn btn-secondary">Saldo Cuenta</button>
            <button id="infoOwner" name="infoOwner" type="button" class="btn btn-secondary">Info Contrato</button>
          </div>
        </div>
        <div class="col-4">
        </div>
      </div>
      <!-- Mensajes -->
      <div class="row">
        <div class="col">
          <div id="infoWallet" class="alert alert-success" role="alert"></div>
        </div>
      </div>
    </div>
    <div class="container-fluid" >
      <div class="row">
        <div id="infoApp" class="alert alert-info" role="alert" style="display: none;"></div>
      </div>
      <div class="row">
        <!-- Botones de acciones -->
        <div class="col-2" id="botonesOperaciones" style="display: none;">
          <div class="btn-group-vertical" role="group" aria-label="Botonera Editor">
            <button type="button" id="altaColaborador" class="btn btn-primary">Nuevo colaborador</button>
            <button type="button" id="verColaboradores" class="btn btn-info">Ver colaboradores</button>
          </div>
          <div class="btn-group-vertical" role="group" aria-label="Botonera Colaborador">
            <button type="button" id="altaPieza" class="btn btn-primary">Nueva pieza</button>
            <button type="button" id="verPiezas" class="btn btn-info">Ver piezas</button>
          </div>
        </div>

        <!-- alta colaboradores -->
        <div class="col-2" id="datosAltaColaborador" style="display: none;">
          <!-- formulario alta colaborador -->
          <form id="formularioDatosColaborador">
            <div class="mb-3">
                <label for="inputNombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="inputNombre">
            </div>
            <div class="mb-3">
                <label for="inputNIF" class="form-label">NIF</label>
                <input type="text" class="form-control" id="inputNIF">
            </div>
            <div class="mb-3">
                <label for="inputTelefono" class="form-label">Teléfono</label>
                <input type="text" class="form-control" id="inputTelefono">
            </div>            
            <div class="mb-3">
              <label for="inputBilleteraColaborador" class="form-label">Dirección Billetera</label>
              <input type="text" class="form-control" id="inputBilleteraColaborador">
            </div>
            <div class="mb-3">
              <label for="inputEmail" class="form-label">Email address</label>
              <input type="email" class="form-control" id="inputEmail" placeholder="name@example.com">
            </div>
            <button id="enviarDatosColaborador"   type="button" class="btn btn-success">Enviar</button>
            <button id="cancelarDatosColaborador" type="button" class="btn btn-danger">Cancelar</button>
          </form>
        </div>

        <!-- listado colaboradores -->
        <div class="col-6" id="datosListadoColaborador" style="display: none;">
          <div class="row">
            <div class="col-5"><span class="textoL1">Listado de Colaboradores</span></div>
            <div class="mb-5">
              <form id="formularioBuscarColaborador">
                <label for="inputBusquedaColaboradorBilletera" class="form-label">Dirección Billetera</label>
                <input type="text" class="form-control" id="inputBusquedaColaboradorBilletera">
                <div class="col-2"><button id="buscarDatosColaborador" type="button" class="btn btn-success">Buscar</button></div>
            </form>
            </div>
          </div>
          <div class="row" id="idListadoColaboradores"></div>
        </div>

        <!-- alta piezas -->
        <div class="col-2" id="datosAlta" style="display: none;">
          <!-- formulario alta pieza -->
          <form id="formularioDatos">
            <div class="mb-3">
              <label for="inputBilletera" class="form-label">Dirección Billetera</label>
              <input type="text" class="form-control" id="inputBilletera">
            </div>
            <div class="mb-3">
              <label for="inputTitulo" class="col-sm-8 col-form-label">Título noticia</label>
              <input type="text" class="form-control" id="inputTitulo">
            </div>
            <div class="mb-3">
              <label for="inputURL" class="col-sm-8 col-form-label">URL noticia</label>
              <input type="text" class="form-control" id="inputURL" size="60">
            </div>
            <button id="enviarDatos"   type="button" class="btn btn-success">Enviar</button>
            <button id="cancelarDatos" type="button" class="btn btn-danger">Cancelar</button>
          </form>
        </div>

        <!-- listado piezas -->
        <div class="col-6" id="datosListado" style="display: none;">
            <div class="row">
              <div class="col-5"><span class="textoL1">Listado de Piezas</span></div>
              <div class="mb-5">
                <form id="formularioBuscarPieza">
                  <label for="inputBusquedaPiezaBilletera" class="form-label">Dirección Billetera</label>
                  <input type="text" class="form-control" id="inputBusquedaPiezaBilletera">
                  <div class="col-2"><button id="buscarDatos" type="button" class="btn btn-success">Buscar</button></div>
                </form>
              </div>
            </div>
            <div class="row" id="idListadoPiezas"></div>          
        </div>

      </div>
    </div>
  </body>

    <script>
      var userAccount;
      var web3js;

      var walletInterval;
      var msgInterval;
      var myActualAddr = null;

      // Para guardar las transacciones y evitar las duplicaciones de eventos
      var listaTrx = {};      

      ///////////////////////////////////////////////////////////////
      // Funciones
      ///////////////////////////////////////////////////////////////

      function verCuentas() {
        
        console.log('Cuenta --->');
        console.log(web3js.eth.accounts);

        console.log('--- CUENTAS ---');
        web3js.eth.getAccounts()
          .then(function(acc){
            console.log('acc:', acc)
          })
        console.log('--- FIN ---');
      }
 
      function obtenerSaldo(_addr) {
        var total = 0;
        if (_addr == null) {
          console.log('ERR--> NO address');
          return total;
        }
        else {
          web3js.eth.getBalance(_addr)
          .then( function(b) {
            total = Web3.utils.fromWei(b, "ether");
            console.log("Total Balance ->", total, " (ethers)");
            alert('Wallet: (' + _addr + ') ' + '\n' + ' Saldo: ' + total);
          })
          .catch( function(r) {
            console.log('ERR obtenerSaldo() -->', r);
          })
        }
        return total;
      }      

      function verContratos() {

        var myContract = new web3js.eth.Contract(myABI, myContractAddress);

        // Ejecutar funciones del SC
        //myContract.methods.myMethod(123).call();
        //myContract.methods.myMethod(123).send();

        // Hash de un mensaje
        //web3js.eth.accounts.hashMessage(message);

        console.log('Contract->');
        console.log(myContract);
      }

      function muestraMensaje(_msg, activaTimer) {
        var panel = document.getElementById("infoApp");
        panel.innerHTML = '<p>' + _msg + '</p>';
        panel.style.display = 'block';

        if (activaTimer) {
          msgInterval = setInterval(function () { 
            document.getElementById("infoApp").style.display = 'none'; 
            document.getElementById("infoApp").innerHTML = '';
            clearInterval(msgInterval);
            msgInterval = null;
          }, 5000);
            
        }
        
      }

      function muestraInfo(_msg) {
        var panel = document.getElementById("infoWallet");
        panel.innerHTML = '<p>' + _msg + '</p>';
      }

      function ocultar(_idObjeto) {
        document.getElementById(_idObjeto).style="display: none;";
      }

      function mostrar(_idObjeto) {
        var campo = document.getElementById(_idObjeto);
        campo.style="display: block;";
        return true;

        if (campo.style.display == 'none') {
          campo.style="display: block;";
        }
        else {
          campo.style="display: none;";
        }
      }

      function obtenerInfoContrato() {
        console.log('obtenerInfoContrato() -->', myContractAddress);
        web3js.eth.getBalance(myContractAddress)
        .then( function(b) {
          total = Web3.utils.fromWei(b, "ether");
          msg = 'Direccion -> ' + myContractAddress + '. Saldo: ' + total + ' (ethers)';
          alert(msg);
        })
        .catch( function(r) {
          console.log('ERR obtenerInfoContrato() -->', r);
        })

      }

      function obtenerTipoObjetos() {
        var tipo = 0;
        var eth = window.ethereum;
        if (eth.selectedAddress != null) {
          // Conectado.
          myActualAddr = eth.selectedAddress;

          console.log('ACTUAL --> ', myActualAddr, ' OWNER --> ', myContractOwner);
          if (myActualAddr == myContractOwner.toLowerCase() ) {
            // Admin
            tipo = 1;
          }
          else {
            // Colaborador
            tipo = 2;
          }
        }

        console.log('TIPO --> ', tipo);
        return tipo;
      }

      function mostrarObjetos(_tipo) {

        mostrar('botonesAcciones');
        if (_tipo == 1) {
          // Admin
          mostrar('altaColaborador');
          mostrar('verColaboradores');
          mostrar('altaPieza');
          mostrar('verPiezas');

          mostrar('botonesOperaciones');
        }
        else {
          if (_tipo == 2) {
            // Colaborador
            ocultar('altaColaborador');
            ocultar('verColaboradores');
            mostrar('altaPieza');
            mostrar('verPiezas');
            
            mostrar('botonesOperaciones');
          }
        }

      }

      function obtenerInfoError(_hash) {
        var hashError = Array();

        var idTransaccion = -1;
        var errCode = -1;
        var errorType = 'error';
        var errorMsg = 'Se ha producido un error genérico';

        if (_hash.code == 4001) {
          idTransaccion = -1;
          errCode = _hash.code;
          errorType = 'cancel';
          errorMsg = 'Se ha cancelado la petición';
        }

        if (_hash.code == -32603) {
          var msgTPL = "[ethjs-query] while formatting outputs from RPC";
          var lenErr = msgTPL.length;
          var msgErr = _hash.message.substr(lenErr + 1);
          msgErr = msgErr.replace(/'/g, '');
          console.log('obtenerInfoError()->', msgErr);

          var jsonErr = JSON.parse(msgErr);
          console.log('error()->', jsonErr);

          console.log('error(H)->', jsonErr['value']['data']['data']);
          var hashErr = jsonErr['value']['data']['data'];
          var arrEntries = Object.entries(hashErr);
          
          console.log(arrEntries);
          console.log(arrEntries[0][0]);
          console.log((arrEntries[0][1]).error);
          console.log((arrEntries[0][1]).reason);

          idTransaccion = arrEntries[0][0];
          errCode = _hash.code;
          errorType = arrEntries[0][1].error;
          errorMsg = arrEntries[0][1].reason;
        }

        hashError.idTransaccion = idTransaccion;
        hashError.errCode       = errCode;
        hashError.errorType     = errorType;
        hashError.errorMsg      = errorMsg;

        return hashError;
      }

      // Comprobar Wallet
      function comprobarBilletera() {

        var eth = window.ethereum;
        console.log('IsMETA-->', eth.isMetaMask);
        console.log('Version-->', eth.networkVersion);
        console.log('Addrr-->', eth.selectedAddress);
        console.log('IsMETA-->', eth.isMetaMask);

        var msgConectado = 'Tiene que conectar la billetera.';
        if (eth.selectedAddress != null) {
          msgConectado = 'Conectado --> ' + eth.selectedAddress;
        }
        var version = '';
        if (eth.networkVersion != null) {
          version = " Versión (" + eth.networkVersion + ")";
        }
        var msg = "Encontrada billetera" + version + ". " + msgConectado;
        muestraInfo(msg);

        if (eth.selectedAddress != null) {
          // Parando timer
          if (walletInterval != null) {
            clearInterval(walletInterval);
          }
          walletInterval = null;

          // Direccion actual
          myActualAddr = eth.selectedAddress;

          // Obteniendo Saldo
          var total = 0;
          web3js.eth.getBalance(myActualAddr)
          .then( function(b) {
            total = Web3.utils.fromWei(b, "ether");
            console.log('Total Balance  (' + myActualAddr + ') ->', total, ' (ethers)');
            msg = msg + '. Saldo: ' + total + ' (ethers)';
            muestraInfo(msg);
          })
          .catch( function(r) {
            console.log('ERR getBalance() -->', r);
          })

          // Mostrar elementos de la pagina
          var tipo =  obtenerTipoObjetos();
          mostrarObjetos(tipo);
        }
      }

      function obtenerDatosColaborador() {
        var datos = {};
        datos['nombre'] = document.getElementById('inputNombre').value;
        datos['nif'] = document.getElementById('inputNIF').value;
        datos['telefono'] = document.getElementById('inputTelefono').value;
        datos['billetera'] = document.getElementById('inputBilleteraColaborador').value;
        datos['email'] = document.getElementById('inputEmail').value;
        return datos;
      }


      ///////////////////////////////////////////////////////////////
      // Manejadores de botones - control eventos
      ///////////////////////////////////////////////////////////////

      // Conectar wallet
      document.getElementById("conectarWallet").addEventListener('click', function(ev) {
        // Para conectarse con la wallet
        if (typeof window.ethereum == 'undefined') {
          console.log('ERR En MetaMask ');
          return false;
        }

        var eth = window.ethereum;
        console.log('Conectando billetera....');
        eth.request(
          {method: 'eth_requestAccounts' }
        )
        .then( function(result) {
          console.log(result);
          comprobarBilletera();
        })
        .catch( function(err) {
          console.log('ERR requestAccounts ->', err);
        });
        
        window.ethereum.on('accountsChanged', function (accounts) {
          console.log('cuenta cambiada!!!!');
          comprobarBilletera();
        });
        window.ethereum.on('chainChanged', function (chainId) {
          console.log('red cambiada!!!!');
          comprobarBilletera();
        });

        //eth.removeListener('accountsChanged', handleAccountsChanged);
        //eth.on('connect', function (c) {});
        //eth.on('disconnect', function (d) {});
        //eth.on('message', function (m) {});
      }, );

      // Saldo wallet
      document.getElementById("saldoWallet").addEventListener('click', function(ev) {
        var addr = myActualAddr;
        if ( document.getElementById("inputCuenta").value != '' ) {
          addr = document.getElementById("inputCuenta").value;
        }
        obtenerSaldo(addr);
      });

      // Info propietario
      document.getElementById("infoOwner").addEventListener('click', function(ev) {

        var myContract = new web3js.eth.Contract(myABI, myContractAddress);
        var ret = myContract.methods.getAddressOwner().call()
        .then( function(g) {
          console.log('getAddressOwner()->',g, ret);
        })
        .catch( function(r) {
          console.log(r);
        });
        ret = myContract.methods.getBalanceOwner().call()
        .then( function(g) {
          console.log('getBalanceOwner()->',g, ret);
        })
        .catch( function(r) {
          console.log(r);
        });

        ret = myContract.methods.getBalanceContract().call()
        .then( function(g) {
          console.log('getBalanceContract()->',g, ret);
        })
        .catch( function(r) {
          console.log(r);
        });
        ret = myContract.methods.getAddressContract().call()
        .then( function(g) {
          console.log('getAddressContract()->',g, ret);
        })
        .catch( function(r) {
          console.log(r);
        });

        obtenerInfoContrato();
        return true;
      });

      //
      // Funciones Piezas
      //
      document.getElementById("altaPieza").addEventListener('click', function(ev) {
        // Ocultar datos
        ocultar('datosListado');
        ocultar('datosAltaColaborador');
        ocultar('datosListadoColaborador');

        document.getElementById("formularioDatos").reset();
        mostrar('datosAlta');
      });

      document.getElementById("cancelarDatos").addEventListener('click', function(ev) {
        // y limpiar campos.....
        document.getElementById("formularioDatos").reset();
        ocultar('datosAlta');
      });
      
      document.getElementById("enviarDatos").addEventListener('click', function(ev) {

        var eth = window.ethereum;
        if (eth.selectedAddress == null) {
          eth.request(
            {method: 'eth_requestAccounts' }
          )
          .then( function(result) {
            console.log(result);
          })
          .catch( function(err) {
            console.log('ERR requestAccounts ->', err);
          });
          return false;
        }        
        var myContract = new web3js.eth.Contract(myABI, myContractAddress);
        var myAddress =  eth.selectedAddress;

        console.log('Contract->', myContract);
        console.log('Methods->', myContract.methods);
        console.log('Mi Address->', myAddress);
        var isAddr = web3js.utils.isAddress(myAddress);
        console.log('IS Address->', isAddr);

        var valorTitulo    = document.getElementById('inputTitulo').value;
        var valorURL       = document.getElementById('inputURL').value;
        var valorBilletera = document.getElementById('inputBilletera').value;

        if ( (valorTitulo == '') || (valorURL == '') ) {
          alert('Hay que completar todos los campos');
          return false;
        }
        if (valorBilletera == '') {
          alert('Hay que completar todos los campos 2');
          return false;
        }
        console.log('insertarPieza()->', valorBilletera);

        console.log('Billetera ->', valorBilletera);
        //var addrBilletera = web3js.utils.toHex(valorBilletera);
        //console.log('Billetera addr ->', addrBilletera);
        //isAddr = web3js.utils.isAddress(addrBilletera);
        //console.log('IS Address->', isAddr);

        myContract.methods.insertarPieza(valorBilletera, valorTitulo, valorURL).send(
          {
            from: myAddress
          }
        )
        .on('transactionHash', function(receipt){
          console.log('transactionHash()->', receipt);

          var msgSpinner = '<span class="info">Esperando confirmación....</span>';
          msgSpinner = msgSpinner + '<div class="d-flex justify-content-center">';
          msgSpinner = msgSpinner + '  <div class="spinner-border" role="status">';
          //msgSpinner = msgSpinner + '    <span class="info">Esperando confirmación....</span>';
          msgSpinner = msgSpinner + '    <span class="visually-hidden">Loading...</span>';
          msgSpinner = msgSpinner + '  </div>';
          msgSpinner = msgSpinner + '</div>';          
          muestraMensaje(msgSpinner, false);
        })
        .on('receipt', function(receipt){
          console.log('onReceipt()->', receipt);
        })
        .on('confirmation', function(confirmationNumber, receipt){
          console.log('confirmation()->', confirmationNumber, receipt);

          var idTransaction = receipt.transactionHash;
          console.log('hash id ->', receipt.transactionHash);
          console.log('conf number->', confirmationNumber);

          if ( ! listaTrx[idTransaction] ) {
            listaTrx[idTransaction] = 1;
            
            var msg = 'Alta realizada correctamente. Id transacción --> ' + idTransaction;
            muestraMensaje(msg, true);
            document.getElementById("formularioDatos").reset();            
          }


        })
        .on('error', function(receipt){
          console.log('error insertarPieza()->', receipt);
        })               
        .then( function(result) {
          console.log('call insertarPieza()->', result);
        })
        .catch( function(r) {
          //console.log(r);
        });

        return true;
      });

      document.getElementById("verPiezas").addEventListener('click', function(ev) {
        // Ocultar datos
        ocultar('datosAlta');
        ocultar('datosAltaColaborador');
        ocultar('datosListadoColaborador');

        document.getElementById("formularioBuscarPieza").reset();
        document.getElementById("idListadoPiezas").innerHTML = '';
        mostrar('datosListado');
      });

      document.getElementById("buscarDatos").addEventListener('click', function(ev) {

        var eth = window.ethereum;
        var myContract = new web3js.eth.Contract(myABI, myContractAddress);
        var myAddress =  eth.selectedAddress;

        console.log('Contract->', myContract);
        console.log('Methods->', myContract.methods);
        console.log('Mi Address->', myAddress);

        var valorBilletera = document.getElementById('inputBusquedaPiezaBilletera').value;

        // Por defecto, la billetera actual
        if (valorBilletera == '') {
          valorBilletera = myAddress;
        }

        myContract.methods.obtenerTodasPiezasColaborador(valorBilletera).call()
        .then( function(result) {
          console.log('obtenerTodasPiezasColaborador()->', result);
          pintaPiezas(valorBilletera, result);
        })
        .catch( function(r) {
          console.log(r);
        });

      });

      function pintaPiezas(tipo, listadoPiezas) {
        var html = '';

        html = html + '<table class="table">';
        html = html + '  <thead>';
        html = html + '  <tr>';        
        var len = listadoPiezas.length;
        if (len > 0) {
          html = html + '<th scope="col">Código</th>';
          html = html + '<th>Titulo</th>';
          html = html + '<th>URL</th>';
          html = html + '<th>Publicado</th>';
          html = html + '<th>Pagado</th>';
        }
        else {
          html = html + '<th scope="col">No hay piezas para esa dirección (' + tipo + ')</th>';
        }
        html = html + '  </tr>';
        html = html + '  </thead>';
        html = html + '  <tbody>';

        for (var i=0; i < len; i++) {
          var p = listadoPiezas[i];
          html = html + '<tr>';
          html = html + '<th scope="row">' + p.codigoPieza + '</th>';
          html = html + '<td>' + p.tituloPieza + '</td>';
          html = html + '<td>' + p.urlPieza + '</td>';
          html = html + '<td>' + p.publicada + '</td>';
          html = html + '<td>' + p.pagada + '</td>';
          html = html + '</tr>';
        }
        html = html + '  </tbody>';
        html = html + '  </table>';
        document.getElementById('idListadoPiezas').innerHTML = html;
      }


      //
      // Funciones Colaboradores
      //
      document.getElementById("altaColaborador").addEventListener('click', function(ev) {
        // Ocultar datos
        ocultar('datosListadoColaborador');
        ocultar('datosAlta');
        ocultar('datosListado');

        document.getElementById("formularioDatosColaborador").reset();
        mostrar('datosAltaColaborador');
      });      

      document.getElementById("cancelarDatosColaborador").addEventListener('click', function(ev) {
        ocultar('datosAltaColaborador');
        // y limpiar campos.....
        document.getElementById("formularioDatosColaborador").reset();
      });

      document.getElementById("enviarDatosColaborador").addEventListener('click', function(ev) {

        var eth = window.ethereum;
        if (eth.selectedAddress == null) {
          eth.request(
            {method: 'eth_requestAccounts' }
          )
          .then( function(result) {
            console.log(result);
          })
          .catch( function(err) {
            console.log('ERR requestAccounts ->', err);
          });
          return false;
        }
        var myContract = new web3js.eth.Contract(myABI, myContractAddress);
        var myAddress =  eth.selectedAddress;

        console.log('Contract->', myContract);
        console.log('Methods->', myContract.methods);
        console.log('Mi Address->', myAddress);

        var datosC = obtenerDatosColaborador();
        console.log('billetera -->', datosC['billetera']);

        // TODO: Comprobar campos en blanco        
        if ( 
          (datosC['billetera'] == '') || (datosC['email'] == '') ||
          (datosC['nombre'] == '') || (datosC['nif'] == '') ||
          (datosC['telefono'] == '')
        ) {
          alert('Hay que completar todos los campos');
          return false;
        }
        if (document.getElementById('inputBilletera').value != '') {
          myAddress = document.getElementById('inputBilletera').value;
        }

        console.log('altaColaborador() -->');
        var ret = myContract.methods.altaColaborador(datosC['billetera'], datosC['nombre'], datosC['nif'], datosC['email'], datosC['telefono'])
          .send(
            {
              from: myAddress,
            } 
          )
          .on('transactionHash', function(receipt){
            console.log('transactionHash()->', receipt);

            var msgSpinner = '<span class="info">Esperando confirmación....</span>';
            msgSpinner = msgSpinner + '<div class="d-flex justify-content-center">';
            msgSpinner = msgSpinner + '  <div class="spinner-border" role="status">';
            //msgSpinner = msgSpinner + '    <span class="info">Esperando confirmación....</span>';
            msgSpinner = msgSpinner + '    <span class="visually-hidden">Loading...</span>';
            msgSpinner = msgSpinner + '  </div>';
            msgSpinner = msgSpinner + '</div>';           
            muestraMensaje(msgSpinner, false);
          })
          .on('receipt', function(receipt){
            console.log('onReceipt()->', receipt);
            // Esperando confirmación
          })
          .on('confirmation', function(confirmationNumber, receipt){
            console.log('confirmation()->', confirmationNumber, receipt);

            var idTransaction = receipt.transactionHash;
            console.log('hash id ->', receipt.transactionHash);
            console.log('conf number->', confirmationNumber);

            if ( ! listaTrx[idTransaction] ) {
              listaTrx[idTransaction] = 1;

              var msg = 'Alta realizada correctamente. Id transacción --> ' + idTransaction;
              muestraMensaje(msg, true);
              document.getElementById("formularioDatosColaborador").reset();
            }
            
          })
          .on('error', function(receipt){
            console.log('error altaColaborador()->', receipt);
            var hashErr = obtenerInfoError(receipt);
            var msgErr = 'ERROR --> ' + hashErr.errorMsg + ' (' + hashErr.errorType + ')';
            console.log(msgErr);
            muestraMensaje(msgErr, true);
          })
          .catch( function(r) {
            //console.log(r);
          });

        /*
        *****************************
        *****************************
        {
          from: myAddress,
          value: Web3.utils.toWei("0.02", "ether"),
          gas: Web3.utils.toWei("30000000000", "ether")
        } 

        // Estimacion de gas
        console.log('Estimando gas.....');
        var pp = web3js.eth.getGasPrice()
        .then( function(g) {
          console.log('retorno()->',g, pp);
        })
        .catch( function(r) {
          console.log(r);
        });        

        console.log('obtenerOwner() -->');
        var ret = myContract.methods.obtenerOwner().estimateGas()
        .then( function(g) {
          console.log('retorno()->',g, ret);
        })
        .catch( function(r) {
          console.log(r);
        });
        return true;
        ****************************
        ****************************
        */

        // Ejecutar funciones del SC
        //myContract.methods.myMethod(123).call();
        //myContract.methods.myMethod(123).send();

        // Hash de un mensaje
        //web3js.eth.accounts.hashMessage(message);

      }); 

      document.getElementById("verColaboradores").addEventListener('click', function(ev) {
        // Ocultar datos
        ocultar('datosAltaColaborador');
        ocultar('datosAlta');
        ocultar('datosListado');

        document.getElementById("formularioBuscarColaborador").reset();
        document.getElementById("idListadoColaboradores").innerHTML = '';
        mostrar('datosListadoColaborador');
      });

      document.getElementById("buscarDatosColaborador").addEventListener('click', function(ev) {

        var eth = window.ethereum;
        var myContract = new web3js.eth.Contract(myABI, myContractAddress);
        var myAddress =  eth.selectedAddress;

        console.log('Contract->', myContract);
        console.log('Methods->', myContract.methods);
        console.log('Mi Address->', myAddress);

        var valorBilletera = document.getElementById('inputBusquedaColaboradorBilletera').value;

        console.log('Mi Address 2->', valorBilletera);
        console.log('HEX ->', web3js.utils.isHex(valorBilletera) );
        console.log('ADDR ->', web3js.utils.isAddress(valorBilletera) );
        //web3.utils.toHex(mixed)

        if (valorBilletera != '') {
          myContract.methods.obtenerColaborador(valorBilletera).call()
          .then( function(result) {
            console.log('obtenerColaborador(' + valorBilletera + ')->', result);
            if (result[0] == "0x0000000000000000000000000000000000000000") {
              pintaColaboradores(valorBilletera, []);
            }
            else {
              console.log('r->', result);
              var len = result.length;
              console.log('len 1-->', len);

              // TODO...revisar!!

              if (len == 6) {
                var nuevo = Array (result);
                pintaColaboradores(valorBilletera, nuevo);
              }
              else {
                pintaColaboradores(valorBilletera, result);
              }
             
            }
          })
          .catch( function(r) {
            console.log(r);
          });
        }
        else {
          myContract.methods.obtenerTodosColaboradores().call()
          .then( function(result) {
            console.log('obtenerTodosColaboradores()->', result);
            pintaColaboradores('TODOS', result);
          })
          .catch( function(r) {
            console.log(r);
          });
        }

      });
      
      function pintaColaboradores(tipo, listadoColaboradores) {
        var html = '';
        var len = listadoColaboradores.length;

        html = html + '<table class="table">';
        html = html + '  <thead>';
        html = html + '  <tr>';

        if (len > 0) {
          html = html + '<th scope="col">NIF</th>';
          html = html + '<th scope="col">Nombre</th>';
          html = html + '<th scope="col">Email</th>';
          html = html + '<th scope="col">Tfno</th>';
          html = html + '<th scope="col">Dirección</th>';
          //html = html + '<th scope="col">Activo</th>';
        }
        else {
          html = html + '<th scope="col">No existen datos para esa dirección (' + tipo + ')</th>';
        }
        html = html + '  </tr>';
        html = html + '  </thead>';

        html = html + '  <tbody>';
        for (var i=0; i < len; i++) {
          var c = listadoColaboradores[i];
          // Proteccion cuando viene solo un elemento
          if (typeof c.addr !== 'undefined') {
            html = html + '<tr>';
            html = html + '<th scope="row">' + c.NIF + '</th>';
            html = html + '<td>' + c.nombre + '</td>';
            html = html + '<td>' + c.email + '</td>';
            html = html + '<td>' + c.tfno + '</td>';
            html = html + '<td>' + c.addr + '</td>';
            //html = html + '<td>' + c.activo + '</td>';
            html = html + '</tr>';
          }
        }
        html = html + '  </tbody>';
        html = html + '  </table>';
        document.getElementById('idListadoColaboradores').innerHTML = html;
      }

      //
      // LOAD
      //
      window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        //if (typeof web3 !== 'undefined') {
        //  web3js = new Web3(window.web3.currentProvider);
        //}
        if (typeof window.ethereum != 'undefined') {
          // Use Mist/MetaMask's provider
          console.log('rama 1-->');
          web3js = new Web3(window.ethereum);

          muestraInfo('Iniciando wallet....');
          walletInterval = setInterval(comprobarBilletera, 300);

          tipoAcceso = obtenerTipoObjetos();
          mostrarObjetos(tipoAcceso);
        }
        /*
        else if (typeof window.web3 !== 'undefined') {
          // Handle the case where the user doesn't have Metamask installed
          console.log('rama 2-->');
          web3js = new Web3(window.web3.currentProvider);
          console.log('currentProvider-->', window.web3.currentProvider);
        }
        */
        else {
          console.log('rama 2 -->');
          web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));

          muestraInfo('Conectando a red. No se ha detectado ninguna billetera.');
        }

      });


    </script>
</html>
 