<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- === <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> === -->
    <!-- === <script language="javascript" type="text/javascript" src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script> === -->
    <script language="javascript" type="text/javascript" src="js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="js/web3.min.js"></script>

    <link href="./css/estilos.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>TFE: App Colaboradores</title>
  </head>
  <body class="main">

    <h2>App de Colaboradores</h2>
    <span>Para enviar piezas y consultar el estado</span>

    <div class="container">
      <!-- Botones de acciones especiales -->
      <div class="row">
        <div id="botones" class="container" style="display:block;">
          <button id="conectarWallet" name="conectarWallet" type="button" class="btn btn-secondary">Conectar Metamask</button>
          <button id="saldoWallet"    name="saldoWallet" type="button" class="btn btn-secondary">Saldo Cuenta</button>
          <button id="cuentasWallet" name="b1" type="button" class="btn btn-secondary">Ver Cuentas</button>

          <button id="b3"  name="b3" type="button" class="btn btn-secondary">Transf desde blockchain</button>
          <button id="b4"  name="b4" type="button" class="btn btn-secondary">Transf desde metmask</button>
          <button id="sc2" name="b2" type="button" class="btn btn-secondary">b2</button>
        </div>
      </div>
      <!-- Mensajes -->
      <div class="row">
        <div class="col">
          <div id="infoWallet" class="alert alert-success" role="alert">aaaa</div>
          <!-- <div id="infoApp"    class="alert alert-info"    role="alert">cccc</div> -->
        </div>
      </div>
    </div>

    <div class="container-fluid" >
      <div class="row">
        <div class="col-2">
          <!-- Botones de acciones -->
          <div class="btn-group-vertical" role="group" aria-label="Basic mixed styles example">
            <button type="button" id="altaPieza" class="btn btn-primary">Nueva pieza</button>
            <button type="button" id="verPiezas" class="btn btn-info">Ver piezas</button>
            <button type="button" id="verPiezas" class="btn btn-secondary">Más opciones</button>
          </div>
        </div>

        <div class="col-2" id="datosAlta" style="display: none;">
          <!-- formulario alta -->
          <div id="datosAlta1" style="display: none;">
            <p><span class="">NIF:</span><input type="text" name="NIF" value="" /></p>
            <p><span class="">TITULO:</span><input type="text" name="titulo" value="" /></p>
            <p><span class="">URL NOTICIA:</span><input type="text" name="URL" value="" /></p>
            <p><span class="">TEXTO NOTICIA:</span><input type="text" name="datos" value="" /></p>
            <input id="submitPieza" name="submitPieza" type="submit" value="Enviar Alta">
            <div class="col">
              <button type="button" class="btn btn-success">Success</button>
              <button type="button" class="btn btn-danger">Danger</button>
            </div>
          </div>
          
          <!-- formulario alta -->
          <form id="formularioDatos">
            <!--
            <div class="mb-3">
              <label for="FormControlInput1" class="form-label">Email address</label>
              <input type="email" class="form-control" id="FormControlInput1" placeholder="name@example.com">
            </div>
            -->
            <div class="mb-3">
              <label for="inputTitulo" class="col-sm-8 col-form-label">Título noticia</label>
              <input type="text" class="form-control" id="inputTitulo">
            </div>
            <div class="mb-3">
              <label for="inputURL" class="col-sm-8 col-form-label">URL noticia</label>
              <input type="text" class="form-control" id="inputURL" size="60">
            </div>
            <div class="mb-3">
              <label for="inputResumen" class="col-sm-8 col-form-label">Resumen noticia</label>
              <input type="text" class="form-control" id="inputResumen">
            </div>
            <button id="enviarDatos"   type="button" class="btn btn-success">Enviar</button>
            <button id="cancelarDatos" type="button" class="btn btn-danger">Cancelar</button>
          </form>
        </div>

        <!-- listado piezas -->
        <div class="col-5" id="datosListado" style="display: none;">
          <div class="row">
            <div class="col-3"><span class="textoL1">Listado de Piezas</span></div>
            <div class="col-2"><button id="buscarDatos" type="button" class="btn btn-success">Buscar</button></div>
            <!--  spinner....
            <div class="spinner-border text-secondary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            -->

          </div>
          <div class="row">
            <div class="col">12</div>
            <div class="col">22</div>
            <div class="col">32</div>
          </div>          
        </div>
      </div>
    </div>

    <script>
      var userAccount;
      var web3js;
      var walletInterval;
      var actualAddr = null;

      // Datos del contrato
      var myABI = [
      {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "_addr",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "string",
            "name": "_nif",
            "type": "string"
          }
        ],
        "name": "evAltaColaborador",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "_addr",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "_codigoPieza",
            "type": "uint256"
          }
        ],
        "name": "evPiezaBorrada",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "_addr",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "codigoPieza",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "string",
            "name": "tituloPieza",
            "type": "string"
          }
        ],
        "name": "evPiezaInsertada",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "_addr",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "_codigoPieza",
            "type": "uint256"
          }
        ],
        "name": "evPiezaPublicada",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "obtenerOwner",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "string",
            "name": "_nif",
            "type": "string"
          }
        ],
        "name": "existeColaborador",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "obtenerTodosColaboradores",
        "outputs": [
          {
            "components": [
              {
                "internalType": "address",
                "name": "addr",
                "type": "address"
              },
              {
                "internalType": "string",
                "name": "nombre",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "NIF",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "email",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "tfno",
                "type": "string"
              },
              {
                "internalType": "bool",
                "name": "activo",
                "type": "bool"
              }
            ],
            "internalType": "struct Colaborador.datosColaborador[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "string",
            "name": "_nif",
            "type": "string"
          }
        ],
        "name": "obtenerColaborador",
        "outputs": [
          {
            "components": [
              {
                "internalType": "address",
                "name": "addr",
                "type": "address"
              },
              {
                "internalType": "string",
                "name": "nombre",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "NIF",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "email",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "tfno",
                "type": "string"
              },
              {
                "internalType": "bool",
                "name": "activo",
                "type": "bool"
              }
            ],
            "internalType": "struct Colaborador.datosColaborador",
            "name": "",
            "type": "tuple"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "_address",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "_nombre",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_nif",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_email",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_tfno",
            "type": "string"
          }
        ],
        "name": "altaColaborador",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "_address",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "_titulo",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_url",
            "type": "string"
          }
        ],
        "name": "insertarPieza",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "_address",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "_codigoPieza",
            "type": "uint256"
          }
        ],
        "name": "borrarPieza",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "addr",
            "type": "address"
          }
        ],
        "name": "obtenerTodasPiezasColaborador",
        "outputs": [
          {
            "components": [
              {
                "internalType": "uint256",
                "name": "codigoPieza",
                "type": "uint256"
              },
              {
                "internalType": "address",
                "name": "addr",
                "type": "address"
              },
              {
                "internalType": "string",
                "name": "tituloPieza",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "urlPieza",
                "type": "string"
              },
              {
                "internalType": "bool",
                "name": "activo",
                "type": "bool"
              },
              {
                "internalType": "bool",
                "name": "publicada",
                "type": "bool"
              }
            ],
            "internalType": "struct Pieza.datosPieza[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "addr",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "_codigoPieza",
            "type": "uint256"
          }
        ],
        "name": "obtenerPieza",
        "outputs": [
          {
            "components": [
              {
                "internalType": "uint256",
                "name": "codigoPieza",
                "type": "uint256"
              },
              {
                "internalType": "address",
                "name": "addr",
                "type": "address"
              },
              {
                "internalType": "string",
                "name": "tituloPieza",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "urlPieza",
                "type": "string"
              },
              {
                "internalType": "bool",
                "name": "activo",
                "type": "bool"
              },
              {
                "internalType": "bool",
                "name": "publicada",
                "type": "bool"
              }
            ],
            "internalType": "struct Pieza.datosPieza",
            "name": "",
            "type": "tuple"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];
      var myContractAddress = '0x3A3Eb954EB2fcAb682eBCAEc5eF48DFDfD5777D9'; // Colaborador
      var myContractOwner   = '0xd504093E3b4043a589Ec8D4c7359B223031eFdbc'; // propietario del contrato (administrador)

      var srcWalletAddr  = '0x9eb3CB5d6e421f876D7B3e7e527eFb40aF076442';
      var destWalletAddr = '0x8Ce9f327bFa7B52508aFbf539663b59c826Fc690';

      ///////////////////////////////////////////////////////////////
      // Funciones
      ///////////////////////////////////////////////////////////////

      function verCuentas() {
        
        console.log('Cuenta --->');
        console.log(web3js.eth.accounts);

        console.log('--- CUENTAS ---');
        web3js.eth.getAccounts()
          .then(function(acc){
            console.log('acc:', acc)
          })
        console.log('--- FIN ---');
      }
 
      function obtenerSaldo(_addr) {
        var total = 0;
        if (_addr == null) {
          console.log('ERR--> NO address');
          return total;
        }
        else {
          web3js.eth.getBalance(_addr)
          .then( function(b) {
            total = Web3.utils.fromWei(b, "ether");
            console.log("Total Balance ->", total, " (ethers)");
            alert('Wallet: (' + actualAddr + ') ' + '\n' + ' Saldo: ' + total);
          })
          .catch( function(r) {
            console.log('ERR obtenerSaldo() -->', r);
          })
        }
        return total;
      }      

      function verContratos() {

        var myContract = new web3js.eth.Contract(myABI, myContractAddress);

        // Ejecutar funciones del SC
        //myContract.methods.myMethod(123).call();
        //myContract.methods.myMethod(123).send();

        // Hash de un mensaje
        //web3js.eth.accounts.hashMessage(message);

        console.log('Contract->');
        console.log(myContract);
      }

      function muestraMensaje(_msg) {
        var panel = document.getElementById("infoApp");
        panel.innerHTML = '<p>' + _msg + '</p>';
      }

      function muestraInfo(_msg) {
        //$("#info").empty();
        //$("#info").append(_msg);
        var panel = document.getElementById("infoWallet");
        panel.innerHTML = '<p>' + _msg + '</p>';
      }

      function ocultarFormulario() {
        document.getElementById("datosAlta").style="display: none;";
      }

      function ocultarListado() {
        document.getElementById("datosListado").style="display: none;";
      }

      // Comprobar Wallet
      function comprobarBilletera() {

        var eth = window.ethereum;
        console.log('IsMETA-->', eth.isMetaMask);
        console.log('Version-->', eth.networkVersion);
        console.log('Addrr-->', eth.selectedAddress);
        console.log('IsMETA-->', eth.isMetaMask);

        var conectado = 'No conectado.';
        if (eth.selectedAddress != null) {
          conectado = 'Conectado --> ' + eth.selectedAddress;
        }
        var version = '';
        if (eth.networkVersion != null) {
          version = " Versión (" + eth.networkVersion + ")";
        }
        var msg = "Encontrada billetera" + version + ". " + conectado;
        muestraInfo(msg);

        if (eth.selectedAddress != null) {
          // Parando timer
          if (walletInterval != null) {
            clearInterval(walletInterval);
          }
          walletInterval = null;
        }

        // Direccion actual
        actualAddr = eth.selectedAddress;
        }



      function pepe1() {

        var myContract = new web3js.eth.Contract(myABI, myContractAddress);
        console.log('Contract->');
        console.log(myContract);
        console.log('Acc:', myContract.defaultAccount); 

        /*
        *************************
        // Ejecutar funciones del SC
        myContract.methods.saluda().call()
          .then( function(aaa) {
            console.log('CALL-saluda():', aaa)
          });
        *******************************
        */

        console.log(myContract.methods);
        myWalletAddr = '0x9eb3CB5d6e421f876D7B3e7e527eFb40aF076442';

        //var aa = myContract.methods.set(3).call();
        myContract.methods.set(3).send(
          {
            from: myWalletAddr,
            //value: web3js.utils.toWei("0.0001", "ether"),
            data: 'dataaaaa'
          }
        )
          .then( function(s) {
            console.log('set()->', s);
          })

          /*
          .then(
            //b = myContract.methods.get().call()
            myContract.methods.get().call()
              .then( function(e) {
                console.log('get()->', e);
              })
          )
          */
          .catch( function(r) {
            console.log(r);
          });


        var b = myContract.methods.get().call()
          .then( function(g) {
            console.log('get()->',g, b);
          })
          .catch( function(r) {
            console.log(r);
          });


        /*
        var a = myContract.methods.setMessage("HOLA HOLA").call()
          .then( function(s) {
            console.log(s);
          })
          .catch( function(r) {
            console.log(r);
          });

        var b = myContract.methods.getMessage().call()
          .then( function(bb) {
            console.log('getMessage():', bb)
          });
        console.log('b:', b);
        */
      }

      function hazTransferencia() {

        // Comprobacion wallet
        if (typeof window.ethereum == 'undefined') {
          console.log('ERR En MetaMask ');
          return false;
        }

        var eth = window.ethereum;
        if (eth.selectedAddress == null) {
          console.log('Billetera no conectada....');
          return false;
        }
        console.log('Addrr-->', eth.selectedAddress);
        var srcWalletAddr = eth.selectedAddress;

        console.log("Mandando transfer a blockchain...");
        web3js.eth.sendTransaction(
          {
            from: srcWalletAddr,
            to: destWalletAddr,
            value: Web3.utils.toWei("0.03", "ether"),
            //value: '100000000000000000'
            //data: '0Xddddd'
            //data: Web3.utils.asciiToHex('hooola')
          }
        )
          .then( function(receipt) {
            console.log('sendTransaction()->', receipt);
          })
          .catch( function(r) {
            console.log(r);
          });        

      }

      //////window.addEventListener('load', function() {
      function LOAD_OLD() {


        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        //if (typeof web3 !== 'undefined') {
        //  web3js = new Web3(window.web3.currentProvider);
        //}
        //if (typeof window.ethereum != 'undefined') {
        if ( 0 ) {
          // Use Mist/MetaMask's provider
          console.log('rama 1-->');
          web3js = new Web3(window.ethereum);
          
        }
        //else if (typeof window.web3 !== 'undefined') {
        else if (0) {
          // Handle the case where the user doesn't have Metamask installed
          console.log('rama 2-->');
          web3js = new Web3(window.web3.currentProvider);

          console.log('currentProvider-->', window.web3.currentProvider);

          //web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
          //console.log('rama 2 -->');
        }
        else {
          console.log('rama 3 -->');
          web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
        }

        /* init billetera
        window.ethereum.request( {method: 'eth_requestAccounts' } )
            .then( function(a) {
              console.log('eth_requestAccounts->', a);
            })
            */


        /*

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        //if (typeof web3js !== 'undefined') {
        if (typeof window.ethereum == 'undefined') {
          // Use Mist/MetaMask's provider
          web3js = new Web3(Web3.currentProvider);
          console.log('rama 1-->', Web3.currentProvider);
          window.ethereum
        }
        else {
          // Handle the case where the user doesn't have Metamask installed
          // Probably show them a message prompting them to install Metamask
          web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
          console.log('rama 2 -->');
        }
        **********
        */

        /* init billetera
        window.ethereum.request( {method: 'eth_requestAccounts' } )
            .then( function(a) {
              console.log('eth_requestAccounts->', a);
            })
            */
        console.log('ethereum-->', window.ethereum);
        console.log('web3-->', window.web3);
        console.log('web3js -->', web3js);
        console.log('currentProvider -->', web3js.currentProvider);

        // Now you can start your app & access web3 freely:
        //startApp()
        //pepe1();
        //pepe2();
      //})
      }
      

      ///////////////////////////////////////////////////////////////
      // Manejadores de botones - control eventos
      ///////////////////////////////////////////////////////////////


      // Conectar wallet
      document.getElementById("conectarWallet").addEventListener('click', function(ev) {
        // Para conectarse con la wallet
        if (typeof window.ethereum == 'undefined') {
          console.log('ERR En MetaMask ');
          return false;
        }

        var eth = window.ethereum;
        console.log('Conectando billetera....');
        eth.request(
          {method: 'eth_requestAccounts' }
        )
        .then( function(result) {
          console.log(result);
          //muestraMensaje('Conectado. Dirección -> ', result[0]);
          comprobarBilletera();
          actualAddr = window.ethereum.selectedAddress;
        })
        .catch( function(err) {
          console.log('ERR requestAccounts ->', err);
        });
        
        eth.on('accountsChanged', function (accounts) {
          console.log('cuenta cambiada!!!!');
          comprobarBilletera();
        });
        eth.on('chainChanged', function (chainId) {
          console.log('red cambiada!!!!');
          comprobarBilletera();
        });

        //eth.removeListener('accountsChanged', handleAccountsChanged);
        //eth.on('connect', function (c) {});
        //eth.on('disconnect', function (d) {});
        //eth.on('message', function (m) {});
      }, );

      // Saldo wallet
      document.getElementById("saldoWallet").addEventListener('click', function(ev) {
        obtenerSaldo(actualAddr);
      }, );

      // Cuentas
      document.getElementById("cuentasWallet").addEventListener('click', function(ev) {
        verCuentas();
        verContratos();
      });      



      document.getElementById("b3").addEventListener('click', function(ev) {
        hazTransferencia();
        return true;
      });

      document.getElementById("b4").addEventListener('click', function(ev) {

        // Comprobacion wallet
        if (typeof window.ethereum == 'undefined') {
          console.log('ERR En MetaMask ');
          return false;
        }

        var eth = window.ethereum;
        if (eth.selectedAddress == null) {
          console.log('Billetera no conectada....');
          return false;
        }

        console.log('Envio desde wallet Metamask');

        var srcWalletAddr = eth.selectedAddress;
        console.log('Addrr-->', srcWalletAddr);

        eth.request(
        {
          method: 'eth_sendTransaction',
          params: [
          {
            from: srcWalletAddr,
            to: destWalletAddr,
            //value: Web3.utils.toWei("0.01", "ether"),
            value: '100000000000000000'
            //gasPrice: '0x09184e72a000',
            //gas: '0x2710',
            //data: Web3.utils.asciiToHex('hola hola')
          }],
        })
          .then( function(receipt) {
            console.log('sendTransaction()->', receipt);
          })
          .catch( function(r) {
            console.log(r);
          }); 

      });

      document.getElementById("sc2").addEventListener('click', function(ev) {
        var srcWalletAddr1  = '0x9eb3CB5d6e421f876D7B3e7e527eFb40aF076442';
        var destWalletAddr1 = '0x8Ce9f327bFa7B52508aFbf539663b59c826Fc690';

        var eth = window.ethereum;
        if (eth.selectedAddress == null) {
          console.log('Billetera no conectada....');
          return false;
        }

        web3js.eth.sendTransaction(
          {
            from: srcWalletAddr1,
            to: destWalletAddr1,
            value: Web3.utils.toWei("0.01", "ether"),
            //value: '100000000000000000'
            //data: '0Xddddd'
            //data: Web3.utils.asciiToHex('hooola')
          }
        )
          .then( function(receipt) {
            console.log('sendTransaction()->', receipt);
          })
          .catch( function(r) {
            console.log(r);
          });        
      });      




      //
      // LOAD
      //
      window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        //if (typeof web3 !== 'undefined') {
        //  web3js = new Web3(window.web3.currentProvider);
        //}
        if (typeof window.ethereum != 'undefined') {
          // Use Mist/MetaMask's provider
          console.log('rama 1-->');
          web3js = new Web3(window.ethereum);

          muestraInfo('Iniciando wallet....');
          walletInterval = setInterval(comprobarBilletera, 300);        
        }
        /*
        else if (typeof window.web3 !== 'undefined') {
          // Handle the case where the user doesn't have Metamask installed
          console.log('rama 2-->');
          web3js = new Web3(window.web3.currentProvider);
          console.log('currentProvider-->', window.web3.currentProvider);
        }
        */
        else {
          console.log('rama 2 -->');
          web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));

          muestraInfo('Conectando a red. No se ha detectado ninguna billetera.');
        }
      })


      //
      // BOTONES FORMULARIO
      //
      document.getElementById("altaPieza").addEventListener('click', function(ev) {

        // Ocultar datos
        ocultarListado();

        var campo = document.getElementById("datosAlta");
        if (campo.style.display == 'none') {
          campo.style="display: block;";
        }
        else {
          campo.style="display: none;";
        }
      });

      document.getElementById("cancelarDatos").addEventListener('click', function(ev) {
        ocultarFormulario();
        // y limpiar campos.....
        document.getElementById("formularioDatos").reset();
      });
      
      document.getElementById("enviarDatos").addEventListener('click', function(ev) {
        alert('Enviando datos....');
      });

      document.getElementById("submitPieza").addEventListener('click', function(ev) {
        var msg = "Enviado datos al SC";
        muestraMensaje(msg);
        alert(msg);
      });

      document.getElementById("verPiezas").addEventListener('click', function(ev) {

        // Ocultar datos
        ocultarFormulario();

        var campo = document.getElementById("datosListado");
        if (campo.style.display == 'none') {
          campo.style="display: block;";
        }
        else {
          campo.style="display: none;";
        }

        return true;

        var myContract = new web3js.eth.Contract(myABI, myContractAddress);

        var eth = window.ethereum;
        if (eth.selectedAddress == null) {
          console.log('Billetera no conectada....');
          console.log('Conectando billetera....');
          eth.request(
            {method: 'eth_requestAccounts' }
          )
          .then( function(result) {
            console.log(result);

            $("#info").empty();
            $("#info").append('<p>' + result  + '</p>');
          })
          .catch( function(err) {
            console.log('ERR requestAccounts ->', err);
          });
          return false;
        }
        var myAddress =  eth.selectedAddress;

        console.log('Contract->', myContract);
        console.log('Methods->', myContract.methods);
        console.log('Mi Address->', myAddress);
        
        console.log('Ver todas las piezas');
        //myContract.methods.obtenerTodasPiezasColaborador(myAddress).call()
        var b = myContract.methods.obtenerTodosColaboradores().call()
          .then( function(g) {
            console.log('retono()->',g, b);
          })
          .catch( function(r) {
            console.log(r);
          });        

        // Ejecutar funciones del SC
        //myContract.methods.myMethod(123).call();
        //myContract.methods.myMethod(123).send();

        // Hash de un mensaje
        //web3js.eth.accounts.hashMessage(message);
      });

      document.getElementById("buscarDatos").addEventListener('click', function(ev) {
        alert('buscar....');
      });

    </script>
  </body>
</html>
 